<%= form_for(@opportunity) do |f| %>
  <% if @opportunity.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@opportunity.errors.count, "error") %> prohibited this opportunity from being saved:</h2>

      <ul>
      <% @opportunity.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= f.label :organisation_id %><br>
    <%= f.collection_select :organisation_id, @organisations, :id, :name %>
  </div>

  <div class="field">
    <%= f.label :person_id %><br>
    <%= f.collection_select :person_id, @people, :id, :full_name %>
  </div>

  <div class="field">
    <%= f.label :job_title %><br>
    <%= f.text_field :job_title %>
  </div>
  <div class="field">
    <%= f.label :job_description %><br>
    <%= f.text_area :job_description %>
  </div>
  <div class="field">
    <%= f.label :category %><br>
    <%= f.text_field :category %>
  </div>
  <div class="actions">
    <%= f.submit %>
  </div>
<% end %>

<script>
  var people = <%= raw(sanitize(@people.map { |person| { id: person.id, name: person.full_name, organisation_id: person.organisation_id } }.to_json, tags: [])) %>;
  var peopleSelectTag = $("#opportunity_person_id");

  function refreshPeople(orgId) {
    var results = "";
    for (var i = 0; i < people.length; i++) {
      var person = people[i];
      if (person.organisation_id == orgId) {
        results += "<option value='" + person.id + "'>" + person.name + "</option>"
      }
    }
    peopleSelectTag.html(results);
  }

  $(document).on("ready", function() {
    refreshPeople($("#opportunity_organisation_id").val());
    $("#opportunity_organisation_id").on("change", function() {
      refreshPeople($(this).val());
    });
  });
</script>
