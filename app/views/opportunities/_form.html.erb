<%= form_for(@opportunity, html: { class: 'form-horizontal' }) do |f| %>
  <% if @opportunity.errors.any? %>
    <div id="error_explanation">
      <h2><%= t('views.general.validation_error', { count: @opportunity.errors.count }) %></h2>

      <ul>
      <% @opportunity.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group">
    <%= f.label :organisation_id, class: 'col-sm-2 control-label' %>
    <div class="col-sm-10">
      <%= f.collection_select :organisation_id, @organisations, :id, :name, {}, { class: 'form-control' } %>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :person_id, class: 'col-sm-2 control-label' %>
    <div class="col-sm-10">
      <%= f.collection_select :person_id, @people, :id, :full_name, {},{ class: 'form-control' } %>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :job_title, class: 'col-sm-2 control-label' %>
    <div class="col-sm-10">
      <%= f.text_field :job_title, class: 'form-control' %>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :job_description, class: 'col-sm-2 control-label' %>
    <div class="col-sm-10">
      <%= f.text_area :job_description, class: 'form-control' %>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :category, class: 'col-sm-2 control-label' %>
    <div class="col-sm-10">
      <%= f.text_field :category, class: 'form-control' %>
    </div>
  </div>

  <div class="form-group">
    <div class="col-sm-10 col-sm-offset-2">
      <%= f.submit 'Save', class: 'btn btn-success'%>
      or
      <%= link_to 'cancel', opportunities_path %>
    </div>
  </div>

<% end %>

<script>
  var people = <%= raw(sanitize(@people.map { |person| { id: person.id, name: person.full_name, organisation_id: person.organisation_id } }.to_json, tags: [])) %>;
  var peopleSelectTag = $("#opportunity_person_id");

  function refreshPeople(orgId) {
    var results = "";
    for (var i = 0; i < people.length; i++) {
      var person = people[i];
      if (person.organisation_id == orgId) {
        results += "<option value='" + person.id + "'>" + person.name + "</option>"
      }
    }
    peopleSelectTag.html(results);
  }

  $(document).on("ready", function() {
    refreshPeople($("#opportunity_organisation_id").val());
    $("#opportunity_organisation_id").on("change", function() {
      refreshPeople($(this).val());
    });
  });
</script>
